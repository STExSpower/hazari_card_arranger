<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hazari Card Arranger</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to right, #ece9e6, #ffffff);
      color: #333;
    }

    header {
      background: #2e86de;
      color: white;
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    h1 { margin: 0; font-size: 28px; }

    .container {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }

    .suit-title {
      font-size: 18px;
      font-weight: bold;
      margin: 20px 0 5px;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
      gap: 8px;
    }

    .card-button {
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f7f7f7;
      cursor: pointer;
      transition: background 0.2s;
      height: 48px;
      width: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-button:hover {
      background: #dff3ff;
    }

    textarea {
      width: 100%;
      height: 80px;
      padding: 10px;
      font-size: 16px;
      margin: 15px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button.action {
      background: #2e86de;
      color: white;
      border: none;
      padding: 10px 16px;
      margin-right: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    button.action:hover {
      background: #145fa8;
    }

    .result {
      margin-top: 25px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #2e86de;
    }

    .set {
      margin-bottom: 15px;
      font-size: 18px;
    }

    .card-chip {
      display: inline-block;
      background: #e3e9f7;
      color: #222;
      border-radius: 12px;
      padding: 2px 6px 2px 2px;
      margin: 2px 4px 2px 0;
      font-size: 15px;
      cursor: pointer;
      border: 1px solid #b3c6e0;
      transition: background 0.2s;
      vertical-align: middle;
    }
    .card-chip:hover {
      background: #d0e6ff;
    }
    .card-chip img {
      pointer-events: none;
      vertical-align: middle;
    }
    .card-button img {
      pointer-events: none;
      vertical-align: middle;
    }

    #selectedCards {
      margin-bottom: 10px;
      min-height: 40px;
    }

    @media screen and (max-width: 600px) {
      .card-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    /* DARK MODE STYLES */
    body.dark {
      background: linear-gradient(to right, #232526, #414345);
      color: #e0e6f0;
    }
    body.dark header {
      background: #111c2e;
      color: #e0e6f0;
    }
    body.dark .container {
      background: #232b38;
      color: #e0e6f0;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }
    body.dark .result {
      background: #1a202a;
      border-left: 4px solid #4a90e2;
    }
    body.dark .card-button {
      background: #2a3442;
      border: 1px solid #3a4a5e;
      color: #e0e6f0;
    }
    body.dark .card-button:hover {
      background: #3a4a5e;
    }
    body.dark textarea {
      background: #232b38;
      color: #e0e6f0;
      border: 1px solid #3a4a5e;
    }
    body.dark .action {
      background: #4a90e2;
      color: #fff;
    }
    body.dark .action:hover {
      background: #2e86de;
    }
    body.dark .card-chip {
      background: #2a3442;
      color: #e0e6f0;
      border: 1px solid #3a4a5e;
    }
    body.dark .card-chip:hover {
      background: #3a4a5e;
    }

    /* Card Animation */
    @keyframes cardFadeIn {
      from { opacity: 0; transform: scale(0.8);}
      to   { opacity: 1; transform: scale(1);}
    }
    @keyframes cardFadeOut {
      from { opacity: 1; transform: scale(1);}
      to   { opacity: 0; transform: scale(0.8);}
    }
    .card-chip.animated-in {
      animation: cardFadeIn 0.3s;
    }
    .card-chip.animated-out {
      animation: cardFadeOut 0.3s;
    }
  </style>
</head>
<body>
  <header>
    <h1>Hazari Card Arranger</h1>
  </header>

  <div class="container">
    <button class="action" id="toggleDark" style="float:right;margin-bottom:10px;">🌙 Dark Mode</button>
    <div style="clear:both"></div>

    <div id="cardPicker"></div>

    <p>
      <strong>Selected Cards (max 13):</strong>
      <span id="cardCount" style="font-weight:normal;color:#2e86de;"></span>
    </p>
    <div id="selectedCards"></div>
    <textarea id="cardInput" placeholder="Click cards above to add them..."></textarea>

    <button class="action" onclick="arrangeCards()">Arrange</button>
    <button class="action" onclick="clearInput()">Clear</button>
    <button class="action" onclick="generateRandomHand()">Random Hand</button>

    <div class="result" id="result"></div>
  </div>

  <script>
    const suits = { "S": "♠", "H": "♥", "D": "♦", "C": "♣" };
    const suitNames = {
      "S": "Spades ♠", "H": "Hearts ♥", "D": "Diamonds ♦", "C": "Clubs ♣"
    };
    const redSuits = ["H", "D"];
    const suitList = ["S", "H", "D", "C"];
    const rankList = ["A", "K", "Q", "J", "10", "9", "8", "7", "6", "5", "4", "3", "2"];
    const rankOrder = {"A": 14, "K":13, "Q":12, "J":11, "10":10, "9":9, "8":8, "7":7, "6":6, "5":5, "4":4, "3":3, "2":2};
    const comboRank = {
      "Troy": 6,
      "Colour Run": 5,
      "Run": 4,
      "Colour": 3,
      "Pair": 2,
      "Indi": 1
    };

    function parseCard(card) {
      return card.length === 3 ? [card.slice(0,2), card[2]] : [card[0], card[1]];
    }

    function cardSymbol(card) {
      const [rank, suit] = parseCard(card);
      return rank + suits[suit];
    }

    // Card image URL (10 is '0' in API)
    function cardImageURL(card) {
      let [rank, suit] = parseCard(card);
      if (rank === "10") rank = "0";
      return `https://deckofcardsapi.com/static/img/${rank}${suit}.png`;
    }

    function isConsecutive(values) {
      const sorted = [...values].sort((a,b) => a - b);
      if (sorted[2] - sorted[0] === 2 && new Set(sorted).size === 3) return true;
      if (sorted.includes(14) && sorted.includes(2) && sorted.includes(3)) {
        const aceLow = sorted.map(v => v === 14 ? 1 : v).sort((a,b)=>a-b);
        return aceLow[2] - aceLow[0] === 2 && new Set(aceLow).size === 3;
      }
      return false;
    }

    function getCombinationType(cards) {
      const ranks = cards.map(c => parseCard(c)[0]);
      const suits = cards.map(c => parseCard(c)[1]);
      const values = ranks.map(r => rankOrder[r]).sort((a,b) => b - a);
      const rankCount = ranks.reduce((acc, r) => (acc[r] = (acc[r] || 0)+1, acc), {});
      if (new Set(ranks).size === 1) return ["Troy", values];
      if (new Set(suits).size === 1 && isConsecutive(values)) return ["Colour Run", values];
      if (isConsecutive(values)) return ["Run", values];
      if (new Set(suits).size === 1) return ["Colour", values];
      if (Object.values(rankCount).includes(2)) return ["Pair", values];
      return ["Indi", values];
    }

    function rankCombo(cards) {
      const [type, vals] = getCombinationType(cards);
      return [comboRank[type], vals];
    }

    function tryCombinations(cards, sizes) {
      if (!sizes.length) return [[]];
      let results = [];
      let size = sizes[0];
      function combine(arr, k, start=0, path=[]) {
        if (path.length === k) {
          const rest = arr.filter(x => !path.includes(x));
          const subresults = tryCombinations(rest, sizes.slice(1));
          for (let sub of subresults) results.push([path, ...sub]);
          return;
        }
        for (let i = start; i < arr.length; i++) {
          combine(arr, k, i + 1, [...path, arr[i]]);
        }
      }
      combine(cards, size);
      return results;
    }

    function arrangeCards() {
      const input = document.getElementById("cardInput").value.trim().split(/\s+/).filter(c => c !== "");
      if (input.length !== 13) {
        alert("Please enter exactly 13 cards.");
        return;
      }
      // Validate unique and valid cards
      const unique = new Set(input);
      if (unique.size !== 13) {
        alert("Duplicate cards detected or invalid input. Please enter 13 unique cards.");
        return;
      }
      for (let card of input) {
        if (!/^(A|K|Q|J|10|9|8|7|6|5|4|3|2)[SHDC]$/.test(card)) {
          alert(`Invalid card: ${card}. Use format like AS, 10H, QC, etc.`);
          return;
        }
      }

      const allArrangements = tryCombinations(input, [3,3,3,4]);
      let bestScore = -1;
      let bestSet = null;

      for (const sets of allArrangements) {
        const score = sets.reduce((sum, group) => {
          const [r, vals] = rankCombo(group);
          return sum + r * 100000 + vals.reduce((a,b) => a + b, 0);
        }, 0);
        if (score > bestScore) {
          bestScore = score;
          bestSet = sets;
        }
      }

      const result = document.getElementById("result");
      if (!bestSet) {
        result.innerHTML = "<b>No arrangement found.</b>";
        return;
      }
      result.innerHTML = "<h2>Best Arrangement</h2>" + 
        [...bestSet]
          .map((set, i) => {
            const [type, values] = getCombinationType(set);
            return { set, type, values, rank: comboRank[type], index: i };
          })
          .sort((a, b) => {
            if (b.rank === a.rank) {
              const aSum = a.values.reduce((x, y) => x + y, 0);
              const bSum = b.values.reduce((x, y) => x + y, 0);
              return bSum - aSum;
            }
            return b.rank - a.rank;
          })
          .map((entry, i) => {
            const cards = entry.set.map(card => 
              `<img src="${cardImageURL(card)}" alt="${card}" style="width:38px;vertical-align:middle;">`
            ).join(" ");
            return `<div class="set">Set ${i+1} (<strong>${entry.type}</strong>): ${cards}</div>`;
          })
          .join("");
    }

    function clearInput() {
      document.getElementById("cardInput").value = "";
      updateSelectedCards();
      document.getElementById("result").innerHTML = "";
    }

    function generateCardButtons() {
      const container = document.getElementById("cardPicker");
      suitList.forEach(suit => {
        const title = document.createElement('div');
        title.className = 'suit-title';
        title.innerHTML = suitNames[suit];
        container.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'card-grid';

        rankList.forEach(rank => {
          const card = rank + suit;
          const btn = document.createElement("button");
          btn.className = "card-button";
          btn.setAttribute("aria-label", `${rank} of ${suitNames[suit]}`);
          btn.innerHTML = `<img src="${cardImageURL(card)}" alt="${card}" style="width:38px;vertical-align:middle;">`;
          btn.onclick = function () {
            const input = document.getElementById("cardInput");
            let current = input.value.trim().split(/\s+/).filter(c => c !== "");
            if (current.length >= 13) {
              alert("You've already selected 13 cards.");
              return;
            }
            if (current.includes(card)) {
              alert("This card is already selected.");
              return;
            }
            current.push(card);
            input.value = current.join(" ");
            updateSelectedCards();
          };
          grid.appendChild(btn);
        });

        container.appendChild(grid);
      });
    }

    // Card Animation: keep track of last selected cards
    let lastSelected = [];

    function updateSelectedCards() {
      const input = document.getElementById("cardInput");
      const selectedDiv = document.getElementById("selectedCards");
      let current = input.value.trim().split(/\s+/).filter(c => c !== "");

      // Animate in new cards
      selectedDiv.innerHTML = current.map(card => {
        let animClass = (!lastSelected.includes(card)) ? "animated-in" : "";
        return `<span class="card-chip ${animClass}" id="chip-${card}" onclick="removeCard('${card}')">
          <img src="${cardImageURL(card)}" alt="${card}" style="width:32px;vertical-align:middle;">
          ×
        </span>`;
      }).join(" ");
      // Animate out removed cards
      lastSelected.forEach(card => {
        if (!current.includes(card)) {
          const chip = document.getElementById(`chip-${card}`);
          if (chip) {
            chip.classList.add("animated-out");
            setTimeout(() => {
              if (chip.parentNode) chip.parentNode.removeChild(chip);
            }, 300);
          }
        }
      });
      lastSelected = current;
      // Update card count
      document.getElementById("cardCount").textContent = `(${current.length} selected)`;
    }

    function removeCard(card) {
      const input = document.getElementById("cardInput");
      let current = input.value.trim().split(/\s+/).filter(c => c !== "" && c !== card);
      input.value = current.join(" ");
      updateSelectedCards();
    }

    document.getElementById("cardInput").addEventListener("input", updateSelectedCards);

    // Dark mode toggle
    document.getElementById("toggleDark").onclick = function() {
      document.body.classList.toggle("dark");
      this.innerHTML = document.body.classList.contains("dark") ? "☀️ Light Mode" : "🌙 Dark Mode";
    };

    // Random Hand Generator
    function generateRandomHand() {
      const allCards = [];
      for (let suit of suitList) {
        for (let rank of rankList) {
          allCards.push(rank + suit);
        }
      }
      // Shuffle and pick 13
      for (let i = allCards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allCards[i], allCards[j]] = [allCards[j], allCards[i]];
      }
      const hand = allCards.slice(0, 13);
      document.getElementById("cardInput").value = hand.join(" ");
      updateSelectedCards();
      document.getElementById("result").innerHTML = "";
    }

    generateCardButtons();
    updateSelectedCards();
  </script>
</body>
</html>
